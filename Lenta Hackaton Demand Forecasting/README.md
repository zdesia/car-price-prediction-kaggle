# Прогнозирование спроса товаров для “Лента”

Проектное  участие в кросс-функциональном хакатоне по разработке ML-продукта предсказательной модели для ООО “Лента” (октябрь 2023 г.)

### Результат работы команды:
Серверное приложение (API), которое предназначено для работы с данными предсказательной модели через интерфейс пользователя

![Принципиальная схема проекта](https://i.ibb.co/dbNcqtk/Flowchart-Diagram.png "Принципиальная схема проекта.")

**Ссылки на репозитории команды:**  &nbsp; &nbsp; &nbsp; [User Interface design](https://www.figma.com/file/oDb87wsTRHsC8vTtINeoBL/Команда-№1-In-Flames%2C-Хакатон.-Лента?type=design&node-id=143-3273&mode=design&t=XnoAmzIit4khUqGa-0)  &nbsp; &nbsp; &nbsp; &nbsp; [Frontend](https://github.com/Jane-Doe666/lenta) &nbsp; &nbsp; &nbsp; &nbsp; [Backend](https://github.com/kvadimas/Lenta_hackathon_backend/tree/main)




## Задача Data Science
Разработка алгоритма прогноза спроса на 14 дней для товаров собственного производства, подготовка для запуска в продуктовое использование

### Содержание репозитория с ML-решением
- [lenta-hackathon-demand-forecasting.ipynb](https://github.com/zdesia/data-competitions/blob/main/Lenta%20Hackaton%20Demand%20Forecasting/lenta-hackathon-demand-forecasting.ipynb) - Ноутбук с исследовательским анализом данных, инжинирингом признаков, обучением модели, валидацией 
-  [lenta/ml](https://github.com/zdesia/data-competitions/tree/main/Lenta%20Hackaton%20Demand%20Forecasting/lenta/ml): скрипт прогнозирования `model.py`, скрипт переобучения модели `retraining.py`, обученная модель `lgbm_model.pkl`
- [lenta/backend](https://github.com/zdesia/data-competitions/tree/main/Lenta%20Hackaton%20Demand%20Forecasting/lenta/backend): скрипт для запуска модели `app.py`

### Стек технологий
`TimeSeries`, `Docker`, `FastAPI`

### Инструкция по запуску на локальной машине

Клонировать репозиторий

```git clone git@github.com:aminaadzhieva/lenta-hackathon-forecasting.git```   
```cd lenta-hackathon-forecasting```

Установить виртуальное окружение

```python3 -m venv venv```

Запустить виртуальное окружение

```source venv/bin/activate```

Установить все зависимости

```pip install -r lenta/requirements.txt```

Запустить сервер

```uvicorn lenta.backend.app:app```

[Запустить систему предсказания](http://127.0.0.1:8000/api/v1/forecast/custom_response_post/) &nbsp; &nbsp; &nbsp; 
[Проверить данные в админке](http://31.129.109.228/admin/)


## Описание ML-решения и резюме

Решалась **задача прогнозирования временного ряда спроса товаров** собственного производства на 14 дней вперёд: **число проданных товаров в штуках**  `pr_sales_in_units` для каждого ***SKU/товара*** (2050 шт. в обучающей выборке) в каждом из ***10 магазинов***.

Заказчиком предоставлены исторические данные о **продажах за 1 год**, а также в закодированном виде товарная иерархия и информация о магазинах.  

Основные **закономерности**, выявленные в результате анализа: 
- ***Годовой тренд***  - спад средних продаж в зимний сезон октябрь-март.
- ***Недельная сезонность*** - пик продаж в субботу, спад в понедельник.
- В течение года несколько высоких ***пиков спроса, в основном в районе праздников***. Самые резкие подъёмы продаж в период Нового года и Пасхи. Подъем продаж начинается за несколько дней до.
- 40,6% записей относятся к продажам по промоакциям. Возможны одновременные продажи товара в одном магазине по промо и без. 
- В данных представлены продукты с ***неполными временными рядами***: продавались только в дни около Пасхи, начали продаваться полгода назад.
- Все мета-признаки как характеристики магазинов и товаров показали влияние на средний спрос

На основе имеющихся данных **сгенерированы новые признаки:**  
- *Календарные*: день недели, число месяца, номер недели, флаг выходного дня (взят из доп. таблицы)
- *Лаговые* признаки 1-30 дней
- *Скользящее среднее* за 7 и 14 предыдущих дней
- *Кластеризация* по характеристикам магазинов и товаров
    
Чтобы временные ряды каждой комбинации Магазин-Товар были полными создан новый датасет, в который добавлены отсутствующие даты с нулевыми продажами.

 Обучение, валидация и выбор лучшего набора гиперпараметров проводится на **кросс-валидации Walk Forward**: подбор гиперпараметров на фолде проводится на valid-выборке, оценка лучшей модели на фолде на test-выборке.   
В итоге выбрана одна модель среди лучших на каждом фолде.

 Предсказание спроса обученной моделью делается последовательно на каждый следующий день с промежуточным перерасчётом лаговых признаков (учитывается предсказанное значение спроса в предыдущий день).

 Для оценки модели использовалась метрика качества  **WAPE**, посчитанная на уровне Магазин-Товар-Дата. 

Лучший результат по качеству и скорости показала модель градиентного бустинга **LightGBM**.  <br>
Полученный результат: WAPE = **0,47**. Модель работает лучше, чем baseline (предсказание последним известным значением) с метрикой 0.69.







#### Взаимодействие 
Для реализации MVP взаимодействие с ML-микросервисом реализовано следующим образом: cкрипт прогнозирования запускается каждую ночь, генерирует предсказания для всех заданных комбинаций Магазин-Товар и сохраняет результат в базу данных. Пользователь взаимодействует с базой данных.

  



