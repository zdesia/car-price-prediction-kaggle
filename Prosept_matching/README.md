# Сервис для полуавтоматической разметки товаров для ООО "Просепт"
Хакатон ноябрь-декабрь 2023 г.
### Команда №14:
- Анастасия Крицкая - предобработка данных, тестирование моделей
- Олеся Круглякова - подбор способа валидации, тестирование моделей, деплой, отчётность, оформление
- Иван Прошин - тестирование моделей, деплой

### Задача проекта

Разработка решения, которое частично автоматизирует процесс сопоставления товаров. Основная идея - предлагать несколько товаров заказчика, которые с наибольшей вероятностью соответствуют размечаемому товару дилера.  Реализуется в виде онлайн сервиса, открываемого в веб-браузере.

### Задача ML-специалистов

Разработать рекомендательную модель, которая будет предлагать несколько наиболее вероятных вариантов названия товара у заказчика к названию товара, используемомому на сайте дилера. 

### Содержание репозитория с ML-решением
- [`prosept-hack-notebook.ipynb`](https://github.com/avkrickaya/Prosept_matching/blob/main/Notebook/prosept-hack-notebook.ipynb) - Ноутбук с анализом, предобработкой данных, обучением модели, валидацией 
-  [`model.py`](https://github.com/avkrickaya/Prosept_matching/blob/main/model.py): скрипт прогнозирования `model.py`
-  [`requirements.txt`](https://github.com/avkrickaya/Prosept_matching/blob/main/requirements.txt) - список требуемых зависимостей
-  `Dockerfile`, `app.py`, `settings.py` - файлы для развёртывания модели 



#### Стек технологий
`Python3` `Pandas` `Sklearn` `Numpy` `pymorphy3` `NLTK` `NLP` `CatBoost` `sentence_transformers` `Docker`



### Инструкция по запуску скрипта 

Клонировать репозиторий

```git clone git@github.com:avkrickaya/Prosept_matching.git```   

Установить виртуальное окружение

```python3 -m venv venv```

Запустить виртуальное окружение

```source venv/bin/activate```

Установить все зависимости

```pip install -r requirements.txt```

Запустить скрипт

```python model.py <json-файл с данными с сайтов дилеров из БД> <json-файл с данными производителя из БД>```


### Метрика качества
Особенности задачи:
- существует только одно соответствующее название в номенклатуре производителя
- заказчик не указал конкретное количество выводимых рекомендаций, запросил настраиваемое количество

Выбрано 5 рекомендаций как оптимальное для решения задачи и отображения для пользователя. Поэтому основная метрика качества для валидации  **accuracy@5** - рассчитывается как доля случаев, когда хотя бы одна из правильных меток присутствует в топ-5 предсказанных.  

Дополнительно оценивались accuracy@1, MRR и accuracy@10, accuracy@20 для подбора грубого поиска в двухэтапную модель. Расчёт  на всех предоставленных размеченных данных.


## Описание ML-решения 

Для подбора использовали только названия продуктов, которые предварительно обрабатывались: частично устранены ошибки в написании, очищены от знаков препинания и стоп-слов, проведена лемматизация, удалены пропуски и дубликаты.

Протестировано несколько способов решения, где для приведения текстовых названий в векторнуое представлние использовались
`TfidfVectorizer`, `sentence_transformers/distilbert` и `sentence_transformers/LaBSE`, а для поиска подходящих названий `cosine_similarity` и `KNN`.  
Среди них выбран один наиболее результативный по метрике accuracy@20. Приоритет был отдан алгоритму `tfidf_matcher`, а не `LaBSE + cos`, так как оба имеют похожий высокий результат в случае предсказаний 20 рекомендаций  97% , но `tfidf_matcher` работает значительно быстрее.  

На финальном стадии протестирована двухэтапная модель: 
`tfidf_matcher` на первом этапе генерирует 20 предсказаний, с точностью 97%, на втором этапе `классификатор CatBoost` предсказывает вероятность соответствия каждой пары <Товар с сайта дилера - Рекомендация> , среди которых отбираются 5 самых высоких.   



Результаты: 
-  Accuracy@5 = 94,2%, 
- в 79,8% случаев правильное название на 1-м месте, MRR = 0,86
<img src="https://github.com/avkrickaya/Prosept_matching/assets/139965241/fd9044a2-f278-4663-9780-6209d7ca2e00" width="50%" height="50%">




## Взаимодействие 
Взаимодействие с ML- модулем в приложении будет организовано по схеме  Batch deployment:    
Предсказания модели рассчитываются с  заданной периодичностью (или при внесении изменений в базу данных). Мы предполагаем, что запуск будет осуществляться  ежедневно ночью после окончания парсинга. Результат сохраняется в базу данных и предоставляется по запросу пользователя:

![image](https://github.com/avkrickaya/Prosept_matching/assets/139965241/b685a874-c26d-4ace-8187-65d8de78f89c)





 Часть | Действие
----------|----
Backend | Инициируется запуск ML-модуля по расписанию или  после окончания  парсинга|
ML + Backend | ML-модуль взаимодействует с бэкендом для получения данных таблиц marketing_product.csv и 'marketing_dealer.csv' из базы данных |
ML | ML-модуль проводит предобработку данных из таблиц и генерирует для каждой записи 5 рекомендованных названий продуктов, отправляет результаты в базу данных  |
Backend | Сгенерированные данные сохраняются в базе данных |
Frontend | Пользователь кликает на название продукта с целью сделать разметку, данные о рекомендациях приходят из базы данных|
