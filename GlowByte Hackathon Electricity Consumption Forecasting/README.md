
<a id='ENG'></a>
<a href="#RUS"><img src='https://img.shields.io/badge/ENG -Go to RUS description-blue'></a>

# eng
Project participation in a cross-functional hackathon to develop an ML product forecasting model for Lenta store chain (October 2023)



###  Stack
`Python 3.11` `Statsmodels` `Pandas` `Numpy` `Lightgbm` `Docker` `FastAPI`




## ML Solution Description and Summary


---

<br>
<br>

<a id='RUS'></a>
<a href="#ENG"><img src='https://img.shields.io/badge/RUS -Go to ENG description-blue'></a>

# Прогнозирование почасового электропотребления в регионе
`TimeSeries` `Retail` `Machine Learning`

Проектное  участие в кросс-функциональном хакатоне по разработке ML-продукта предсказательной модели для ООО “Лента” (октябрь 2023 г.)


**Задача:**  
Разработка модели прогнозирования общего энергопотребления региона на каждый час, в МВт*ч

**Цель:**  
Разработать надежную и точную модель прогнозирования объема
энергопотребления на сутки для Калининградской области с использованием
доступных исторических данных 


**Данные:**

- `train_dataset.csv` – исторические данные о потреблении энергии за период 2019-01-01 - 2023-03-31
     * *date* – дата;
     * *time* – время,  время  представлено  в  диапазоне  0  –  23,  что  означает  24 часа в сутках;
     * *target* – фактическое потребление на указанную дату;
     * *temp* – фактическая температура на указанную дату;
     * *temp_pred* – прогноз температуры на указанную дату;
     * *weather_fact* – фактическая погода на указанную дату;
     * *weather_pred* – прогноз погоды на указанную дату;


- `test_dataset.csv` – исторические данные о потреблении энергии за период 2023-04-01 – 2023-07-31

### Содержание репозитория с ML-решением
- [lenta-hackathon-demand-forecasting.ipynb](https://github.com/zdesia/data-competitions/blob/main/Lenta%20Hackaton%20Demand%20Forecasting/lenta-hackathon-demand-forecasting.ipynb) - Ноутбук с исследовательским анализом данных, инжинирингом признаков, обучением модели, валидацией 
-  [lenta/ml](https://github.com/zdesia/data-competitions/tree/main/Lenta%20Hackaton%20Demand%20Forecasting/lenta/ml): скрипт прогнозирования `model.py`, скрипт переобучения модели `retraining.py`, обученная модель `lgbm_model.pkl`
- [lenta/backend](https://github.com/zdesia/data-competitions/tree/main/Lenta%20Hackaton%20Demand%20Forecasting/lenta/backend): скрипт для запуска модели `app.py`

### Стек технологий
`Python 3.11` `Statsmodels` `Pandas` `Numpy` `Lightgbm` `Docker` `FastAPI`
  


## Описание ML-решения и резюме

В проекте решалась **задача прогнозирования временного ряда спроса товаров** собственного производства на 14 дней вперёд: **число проданных товаров в штуках**  `pr_sales_in_units` для каждого ***SKU/товара*** (2050 шт. в обучающей выборке) в каждом из ***10 магазинов***.

Заказчиком предоставлены исторические данные о **продажах за 1 год**, а также в закодированном виде товарная иерархия и информация о магазинах.  

Основные **закономерности**, выявленные в результате анализа: 
- ***Годовой тренд***  - спад средних продаж в зимний сезон октябрь-март.
- ***Недельная сезонность*** - пик продаж в субботу, спад в понедельник.
- В течение года несколько высоких ***пиков спроса, в основном в районе праздников***. Самые резкие подъёмы продаж в период Нового года и Пасхи. Подъем продаж начинается за несколько дней до.
- 40,6% записей относятся к продажам по промоакциям. Возможны одновременные продажи товара в одном магазине по промо и без. 
- В данных представлены продукты с ***неполными временными рядами***: продавались только в дни около Пасхи, начали продаваться полгода назад.
- Все мета-признаки как характеристики магазинов и товаров показали влияние на средний спрос

На основе имеющихся данных **сгенерированы новые признаки:**  
- *Календарные*: день недели, число месяца, номер недели, флаг выходного дня (взят из доп. таблицы)
- *Лаговые* признаки 1-30 дней
- *Скользящее среднее* за 7 и 14 предыдущих дней
- *Кластеризация* по характеристикам магазинов и товаров
    
Чтобы временные ряды каждой комбинации Магазин-Товар были полными создан новый датасет, в который добавлены отсутствующие даты с нулевыми продажами.

 Обучение, валидация и выбор лучшего набора гиперпараметров проводится на **кросс-валидации Walk Forward**: подбор гиперпараметров на фолде проводится на valid-выборке, оценка лучшей модели на фолде на test-выборке.   
В итоге выбрана одна модель среди лучших на каждом фолде.

 Предсказание спроса обученной моделью делается последовательно на каждый следующий день с промежуточным перерасчётом лаговых признаков (учитывается предсказанное значение спроса в предыдущий день).

 Для оценки модели использовалась метрика качества  **WAPE**, посчитанная на уровне Магазин-Товар-Дата. 

Лучший результат по качеству и скорости показала модель градиентного бустинга **LightGBM**.  <br>
Полученный результат: WAPE = **0,47**. Модель работает лучше, чем baseline (предсказание последним известным значением) с метрикой 0.69.
